<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENDFIELD</title>

    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="stage">

        <img id="image0" class="will-change-transform" src="assets/image/image0.png" alt="">
        <img id="image00" class="will-change-transform" src="assets/image/image0.png" alt="">

        <div id="box0" class="will-change-transform" data-tilt data-tilt-full-page-listening data-tilt-max="5" data-tilt data-tilt-reset="false">
            <img id="infoboard" class="lowblur" src="assets/image/infoboard.png" alt="">
            <img id="infoboard1" class="nonepoint" src="assets/image/infoboard1.png" alt="">
            <img id="infoboard2" class="nonepoint" src="assets/image/infoboard2.png" alt="">

            <div id="sanity-line" class="line nonepoint">
                <div id="sanity-fill" class="line-fill nonepoint"></div>
            </div>
            <div id="act-line" class="line nonepoint">
                <div id="action-fill" class="line-fill nonepoint"></div>
            </div>
            <div id="pass-line" class="line nonepoint">
                <div id="passion-fill" class="line-fill nonepoint"></div>
            </div>
            <div id="level-line" class="line nonepoint">
                <div id="level-fill" class="line-fill nonepoint"></div>
            </div>
            <div id="sanity-num" class="num-text nonepoint">00</div>
            <div id="act-num" class="num-text nonepoint">00</div>
            <div id="pass-num" class="num-text nonepoint">00</div>
            <div id="level-num" class="num-text nonepoint">00</div>
            <div id="sanity-max" class="num-text nonepoint">00</div>
            <div id="username" class="num-text nonepoint">UserNotFound</div>
            <div id="useruid" class="num-text nonepoint">0000000000</div>

            <img id="image7" src="assets/image/image7.png" alt="">

            <img id="button0" src="assets/image/button0.png" alt="">
            <img id="button1" src="assets/image/button1.png" alt="">

            <img id="usercard" src="assets/image/usercard.png" alt="">
            <img id="usercard1" class="nonepoint nonepoint" src="assets/image/usercard1.png" alt="">
            <img id="usercard2" class="nonepoint nonepoint" src="assets/image/usercard2.png" alt="">
            <img id="usericon" class="nonepoint nonepoint" src="assets/image/noneuser.png">
            <div class="button2stage" id="button2stage">
                <img id="button2" src="assets/image/button2.png" alt="">
                <img id="button20" src="assets/image/button20.png" alt="">
                <img id="button22" class="button22" src="assets/image/button22.png">
                <img id="button23" class="button22" src="assets/image/button23.png">
            </div>
        </div>

        <div id="box1" class="will-change-transform" data-tilt data-tilt-full-page-listening data-tilt-max="3" data-tilt data-tilt-reset="false">
            <img id="image2" src="assets/image/image2.png" alt="">
            <img id="image4" src="assets/image/image4.png" alt="">
            <img id="image6" src="assets/image/image6.png" alt="">
            <img id="image8" src="assets/image/image8.png" alt="">
            <img id="image9" src="assets/image/image9.png" alt="">

            <div id="clock">00:00</div>
            <div id="date">2026/02/12 THU</div>
        </div>

        <video id="video1" preload="auto" autoplay loop muted playinline>
            <source id="video1-src" src="assets/video/video1_2k.webm" type="video/webm">
        </video>

        <img id="image1" src="assets/image/image1.png" alt="">
        <img id="image5" src="assets/image/image5.png" alt="">
        <img id="image3" src="assets/image/image3.png" alt="">
        <img id="image30" src="assets/image/image30.png" alt="">

        <video id="kanrinin" autoplay loop muted playinline>
            <source id="kanrinin-src" src="assets/video/kanrinin_2k.webm" type="video/webm">
        </video>

        <div id="login-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <span class="modal-title">链接账号 | TERMINAL AUTH</span>
                    <button id="reboot" class="close-btn" onclick="rebootTerminal()" style="position: relative; right: -20px;">
                        <img src="assets/svg/repeat.svg" style="width: 18px;" alt="">
                    </button>
                    <button id="close-modal" class="close-btn">
                        <img src="assets/svg/x.svg" style="width: 18px;" alt="">
                    </button>
                </div>
                
                <div id="modal-body" class="modal-body">
                </div>
                
                <div class="modal-footer">
                    <div class="system-line"></div>
                </div>
            </div>
        </div>
        <div id="tips-modal" class="modal-overlay" style=" z-index: 1999; display: none;"></div>
        <div id="notice-stage" style="display: none;">
            <div class="modal-content" style="width: 400px; height: 50px; padding: 5px 15px;display: flex;align-items: center;justify-content: center;">
                <span id="notice-msg" style="font-size: 22px;">MESSAGE</span>
            </div>
        </div>


    <script src="assets/js/time.js"></script>
    <script src="assets/js/vanilla-tilt.js"></script>
    <script src="assets/js/quality.js"></script>
    <script src="assets/js/button.js"></script>
    <script src="assets/js/data.js"></script>
    <script src="assets/js/listener.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        // 1. 初始化鉴权插件
        const auth = new EndfieldAuth({
            baseUrl: 'https://end-api.shallow.ink',
            
            // 状态监听：驱动 UI 更新
            onStatusChange: (status) => {
                console.log("Terminal Status:", status);
                if (modal && modal.style.display === 'flex') {
                    renderModal();
                }
                if (status === 'ACTIVE') {
                }
            },

            // 数据更新：对接 setBar 函数
            onDataUpdate: (data) => {
                if (typeof setBar === 'function') {
                    setBar(
                        data.stamina.current,
                        data.stamina.max,
                        data.dailyMission.activation,
                        data.bpSystem.curLevel,
                        data.base.level,
                        data.base.name,
                        data.base.roleId
                    );
                }
                
                // 头像更新：使用 API 代理绕过防盗链
                const userIcon = document.getElementById('usericon');
                if (userIcon && data.base.avatarUrl) {
                    userIcon.src = `https://end-api.shallow.ink/api/proxy/image?url=${encodeURIComponent(data.base.avatarUrl)}`;
                }
            }
        });

        // 2. 启动鉴权系统
        auth.init();
        
        // 每5min静默刷新数据
        setInterval(() => auth.refreshData(), 300000);

        // 3. 弹窗按钮监听
        document.getElementById('button0').addEventListener('click', () => {
            modal.style.display = 'flex';
            renderModal();
        });
        document.getElementById('close-modal').addEventListener('click', () => {
            modal.style.display = 'none';
        });

        const infoBoard = document.getElementById('box0');
        let refresh = true;
        infoBoard.addEventListener('click', (e) => { 
            if (e.target.closest('#button0, #button1, #button2stage')) {
                return; 
            }
            
            if (infoBoard.vanillaTilt && e.target.closest('#usercard, #infoboard')) {
                if (refresh){
                    refresh = false;
                    auth.refreshData();
                    setTimeout(() => {refresh = true;}, 5000);
                    showNotice("刷新成功！");
                } else{
                    showNotice("操作频繁，稍后再试！");
                }
                infoBoard.vanillaTilt.impact(10, 5, 4);
            }
        });
    </script>

</body>
</html>